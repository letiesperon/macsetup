#!/bin/bash

# Spotify Downloader Script
# Usage: spotify <spotify_url>

set -e  # Exit on any error

# Configuration
SPOTDL_PATH="/Users/letiesperon/Library/Python/3.9/bin/spotdl"
BASE_DIR="/Users/letiesperon/Desktop/Spotify"
SPOTIFY_URL="$1"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if URL is provided
if [ -z "$SPOTIFY_URL" ]; then
    print_error "Please provide a Spotify URL"
    echo "Usage: spotify <spotify_playlist_or_track_url>"
    echo "Examples:"
    echo "  spotify https://open.spotify.com/playlist/37i9dQZF1DXcBWIGoYBM5M"
    echo "  spotify https://open.spotify.com/track/4iV5W9uYEdYUVa79Axb7Rh"
    exit 1
fi

# Create base directory if it doesn't exist
mkdir -p "$BASE_DIR"

# Check if it's a playlist or track
if [[ "$SPOTIFY_URL" == *"/playlist/"* ]]; then
    print_status "Detected playlist URL"

    # Extract playlist ID and get playlist name
    print_status "Getting playlist information..."

    # Use spotdl to get playlist info and extract name
    PLAYLIST_INFO=$($SPOTDL_PATH --save --output /tmp "$SPOTIFY_URL" 2>/dev/null || echo "")

    # Try to extract playlist name from the URL by making a simple request
    # We'll use a safe fallback name if we can't get the real name
    PLAYLIST_NAME=$(echo "$SPOTIFY_URL" | sed 's/.*playlist\///; s/?.*//; s/[^a-zA-Z0-9]/_/g')

    # If playlist name is just ID, try to get a better name
    if [ ${#PLAYLIST_NAME} -eq 22 ]; then
        PLAYLIST_NAME="Playlist_$PLAYLIST_NAME"
    fi

    OUTPUT_DIR="$BASE_DIR/$PLAYLIST_NAME"
    print_status "Downloading playlist to: $OUTPUT_DIR"

elif [[ "$SPOTIFY_URL" == *"/track/"* ]]; then
    print_status "Detected track URL"
    OUTPUT_DIR="$BASE_DIR"
    print_status "Downloading track to: $OUTPUT_DIR"

else
    print_error "Invalid Spotify URL. Please provide a playlist or track URL."
    exit 1
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Download with spotdl
print_status "Starting download..."
echo "----------------------------------------"

if $SPOTDL_PATH --output "$OUTPUT_DIR" "$SPOTIFY_URL"; then
    echo "----------------------------------------"
    print_success "Download completed!"
    print_success "Files saved to: $OUTPUT_DIR"

    # Show what was downloaded
    DOWNLOAD_COUNT=$(find "$OUTPUT_DIR" -name "*.mp3" | wc -l | xargs)
    print_success "Downloaded $DOWNLOAD_COUNT songs"

    # Open the folder in Finder
    print_status "Opening download folder..."
    open "$OUTPUT_DIR"

else
    echo "----------------------------------------"
    print_error "Download failed or was interrupted"
    print_warning "Some files may have been partially downloaded"
    print_status "Check the folder: $OUTPUT_DIR"
    exit 1
fi
