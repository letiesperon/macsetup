#!/bin/bash

# Script to show detailed information about failed Spotify downloads
# Usage: spotify-failed

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

LOG_FILE="/tmp/spotify_download.log"

echo "üéµ Spotify Download Failed Songs Report"
echo "======================================="

if [ ! -f "$LOG_FILE" ]; then
    print_error "No download log found at $LOG_FILE"
    print_status "Run a spotify download first to generate a log"
    exit 1
fi

# Extract playlist info
PLAYLIST_INFO=$(grep "Found [0-9]* songs in" "$LOG_FILE" | head -1)
if [ -n "$PLAYLIST_INFO" ]; then
    print_status "$PLAYLIST_INFO"
    echo ""
fi

# Count total failures
FAILED_COUNT=$(grep -c "AudioProviderError\|ERROR.*download\|Failed to download" "$LOG_FILE" 2>/dev/null || echo "0")
SKIPPED_COUNT=$(grep -c "Skipping.*file already exists" "$LOG_FILE" 2>/dev/null || echo "0")
SUCCESS_COUNT=$(grep -c "Downloaded.*https://" "$LOG_FILE" 2>/dev/null || echo "0")

print_success "$SUCCESS_COUNT songs downloaded successfully"
print_status "$SKIPPED_COUNT songs were skipped (already existed)"
if [ "$FAILED_COUNT" -gt 0 ]; then
    print_warning "$FAILED_COUNT songs failed to download"
else
    print_success "No failed downloads! üéâ"
    exit 0
fi

echo ""
echo "üìã DETAILED FAILED SONGS:"
echo "========================"

# Show detailed failed songs with context
grep -B 1 -A 1 "AudioProviderError\|ERROR.*download" "$LOG_FILE" 2>/dev/null | while IFS= read -r line; do
    if [[ "$line" == *"Downloaded"* ]] && [[ "$line" == *"https://"* ]]; then
        # Extract song name from download attempt
        SONG_NAME=$(echo "$line" | sed 's/Downloaded "//' | sed 's/":.*//')
        echo "‚ùå $SONG_NAME"
    elif [[ "$line" == *"AudioProviderError"* ]]; then
        # Show the error reason
        ERROR_MSG=$(echo "$line" | sed 's/AudioProviderError: //')
        echo "   ‚îî‚îÄ Error: $ERROR_MSG"
        echo ""
    fi
done

echo "üí° TIPS:"
echo "- Some songs may not be available on YouTube"
echo "- Geographic restrictions may apply" 
echo "- Copyright issues can prevent downloads"
echo "- Try running the download again - sometimes it works on retry"

echo ""
print_status "Full log available at: $LOG_FILE"